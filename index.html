<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Canal de comunicação - Confia Paraná</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome for Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <style>
    body { font-family: Arial, sans-serif; background-color: #f8f9fa; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .top-header { display: flex; justify-content: flex-end; padding: 10px 0; border-bottom: 1px solid #dee2e6; margin-bottom: 15px; }
    .header { background-color: #007bff; color: white; padding: 15px; border-radius: 5px 5px 0 0; margin-top: 0; }
    .company-table, .communications-panel-table { background-color: white; border-radius: 5px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); }
    .chat-box { background-color: white; border: 1px solid #007bff; border-radius: 5px; padding: 20px; margin-top: 20px; display: none; }
    .chat-messages { max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-bottom: 20px; background-color: #f1f1f1; border-radius: 5px; }
    .message { margin-bottom: 10px; word-wrap: break-word; }
    .message .sender { font-weight: bold; color: #007bff; }
    .message .status { color: #888; font-size: 0.9em; }
    .inbox-icon { color: #007bff; }
    .inbox-icon.active { color: #28a745; }
    .inbox-button.active { background-color: #ffc107; border-color: #ffc107; }
    .message-input { resize: none; height: 100px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); }
    .survey-card { background-color: #e9ecef; border: 1px solid #007bff; border-radius: 5px; padding: 15px; margin-top: 15px; }
    .role-label { font-weight: bold; color: #28a745; }
    .inbox-count { background-color: #dc3545; color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.8em; margin-left: 5px; }
    .role-buttons .btn { margin-right: 5px; }
    .message-input:disabled, #sendMessageBtn:disabled { background-color: #e9ecef; cursor: not-allowed; }
    #communicationsPanel { margin-top: 20px; border: 1px solid #ccc; padding: 15px; background-color: #f0f0f0; border-radius: 5px; }
    .panel-filters { margin-bottom: 15px; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Top Header for Panel Button (Auditor Only) -->
    <div class="top-header" id="panelButtonContainer" style="display: none;"> <!-- Initially hidden -->
      <button id="communicationsPanelBtn" class="btn btn-secondary" onclick="toggleCommunicationsPanel()">Painel de Comunicações</button>
    </div>

    <!-- Role Switcher -->
    <div class="mb-3 role-buttons">
      <div class="btn-group" role="group">
        <button type="button" class="btn btn-warning" onclick="switchRole('AUDITOR')">Testar como AUDITOR</button>
        <button type="button" class="btn btn-warning" onclick="switchRole('CASA LIMPA')">CASA LIMPA</button>
        <button type="button" class="btn btn-warning" onclick="switchRole('ABS LOG')">ABS LOG</button>
        <button type="button" class="btn btn-warning" onclick="switchRole('CAPIXABA')">CAPIXABA</button>
      </div>
      <span class="role-label ms-3">Usuário Atual: <span id="currentRole">AUDITOR</span></span>
    </div>

	<div id="inboxContainer">
		<!-- Main Header -->
		<div class="header d-flex justify-content-between align-items-center">
		  <h1>Consulta de Empresas - Confia Paraná</h1>
		  <div>
			<button id="inboxBtn" class="btn btn-info inbox-button" onclick="toggleInboxView()">
			  <i class="fas fa-envelope inbox-icon" id="inboxIcon"></i> Caixa de Entrada
			  <span id="inboxCount" class="inbox-count" style="display: none;">0</span>
			</button>
		  </div>
		</div>
	</div>
    <!-- Communications Panel (Auditor Only, Initially Hidden) -->
    <div id="communicationsPanel" style="display: none;">
      <h3>Painel de Comunicações</h3>
      <!-- Panel Filters -->
      <div class="panel-filters row g-3">
        <div class="col-md-5">
          <label for="panelCnpjFilter" class="form-label">Filtrar por CNPJ:</label>
          <input type="text" id="panelCnpjFilter" class="form-control form-control-sm" placeholder="Digite o CNPJ">
        </div>
        <div class="col-md-5">
          <label for="panelNameFilter" class="form-label">Filtrar por Razão Social:</label>
          <input type="text" id="panelNameFilter" class="form-control form-control-sm" placeholder="Digite parte do nome">
        </div>
        <div class="col-md-2 align-self-end">
          <button class="btn btn-primary btn-sm w-100" onclick="populateCommunicationsPanel()">Filtrar Painel</button>
        </div>
      </div>
      <!-- Panel Table -->
      <div class="communications-panel-table">
        <table class="table table-sm table-striped">
          <thead>
            <tr>
              <th>ID</th>
              <th>CNPJ</th>
              <th>Empresa</th>
              <th>Assunto</th>
              <th>Status</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="communicationsPanelList"></tbody>
        </table>
      </div>
      <button class="btn btn-secondary btn-sm mt-2" onclick="toggleCommunicationsPanel()">Fechar Painel</button>
    </div>
	<div id="consultaEmpresasContainer">
		<!-- Main Filters -->
		<div class="filters mt-3 d-flex flex-wrap gap-3">
		  <div>
			<label for="statusFilter" class="form-label">Filtrar por Status Última Comunicação:</label>
			<select id="statusFilter" class="form-select">
			  <option value="">Todos</option>
			  <option value="Em análise">Em análise</option>
			  <option value="Resolvida">Resolvida</option>
			  <option value="Encerrada">Encerrada</option>
			  <option value="Sem comunicação">Sem comunicação</option>
			</select>
		  </div>
		  <div>
			<label for="cnpjFilter" class="form-label">CNPJ:</label>
			<input type="text" id="cnpjFilter" class="form-control" placeholder="Digite o CNPJ">
		  </div>
		  <div class="align-self-end">
			<button class="btn btn-info" onclick="applyFilters()">Filtrar Empresas</button>
		  </div>
		</div>
	

		<!-- Company List -->
		<div class="company-table mt-3">
		  <table class="table table-striped">
			<thead>
			  <tr>
				<th>CNPJ</th>
				<th>Razão Social</th>
				<th>Classificação</th>
				<th>Divulgar</th>
				<th>Ações</th>
			  </tr>
			</thead>
			<tbody id="companyList"></tbody>
		  </table>
		</div>
	</div>

    <!-- Chat Box -->
    <div class="chat-box" id="chatBox">
      <h3>Comunicação <span id="chatCommId" class="badge bg-secondary"></span> com <span id="companyName"></span> (CNPJ: <span id="companyCNPJ"></span>)</h3>
      <div class="row mb-3">
        <div class="col-md-4">
          <label for="subject" class="form-label">Assunto:</label>
          <select id="subject" class="form-select">
            <option value="Confia Paraná">Confia Paraná</option>
            <option value="Consulta Fiscal">Consulta Fiscal</option>
            <option value="Atualização de Dados">Atualização de Dados</option>
            <option value="Outros">Outros</option>
          </select>
        </div>
        <div class="col-md-4">
          <label for="attachment" class="form-label">Anexar Arquivo:</label>
          <input type="file" id="attachment" class="form-control">
        </div>
        <div class="col-md-4">
          <label for="auditor" class="form-label">Relacionamento com Auditor Fiscal:</label>
          <select id="auditor" class="form-select">
            <option value="Auditor 1">Auditor 1 (Pré-selecionado)</option>
          </select>
        </div>
      </div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="mb-3">
        <textarea id="messageInput" class="form-control message-input" placeholder="Escreva sua mensagem aqui..."></textarea>
      </div>
      <div class="d-flex gap-2 mb-3">
        <button class="btn btn-primary" onclick="sendMessage()" id="sendMessageBtn">Enviar Mensagem</button>
        <button class="btn btn-danger" onclick="closeChat()" id="closeChatBtn" style="display: none;">Fechar Comunicação</button>
      </div>
      <!-- Auditor Evaluation -->
      <div id="surveyAuditor" style="display: none;" class="survey-card">
        <h4>Resultado do contato</h4>
        <div class="mb-3" id="surveyQuestionsAuditor">
          <label class="form-label">Comunicação com:</label>
          <select id="communicationWithAuditor" class="form-select">
            <option value="">Selecione...</option>
            <option value="CONTADOR">CONTADOR</option>
            <option value="SÓCIO">SÓCIO</option>
          </select>
          <label class="form-label mt-3">Vantagens Programa:</label>
          <select id="programAdvantagesAuditor" class="form-select">
            <option value="">Selecione...</option>
            <option value="SIM">SIM</option>
            <option value="NÃO">NÃO</option>
          </select>
          <label class="form-label mt-3">Regularização Pendências:</label>
          <select id="pendingResolutionAuditor" class="form-select">
            <option value="">Selecione...</option>
            <option value="de 1 a 30 dias">de 1 a 30 dias</option>
            <option value="de 30 a 90 dias">de 30 a 90 dias</option>
            <option value="acima de 90 dias">acima de 90 dias</option>
            <option value="não há pendências">não há pendências</option>
          </select>
          <label class="form-label mt-3">Nota da comunicação:</label>
          <div class="rating-radios" id="ratingAuditor">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="auditorRating" id="auditorRating1" value="1">
              <label class="form-check-label" for="auditorRating1">1</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="auditorRating" id="auditorRating2" value="2">
              <label class="form-check-label" for="auditorRating2">2</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="auditorRating" id="auditorRating3" value="3">
              <label class="form-check-label" for="auditorRating3">3</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="auditorRating" id="auditorRating4" value="4">
              <label class="form-check-label" for="auditorRating4">4</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="auditorRating" id="auditorRating5" value="5">
              <label class="form-check-label" for="auditorRating5">5</label>
            </div>
          </div>
        </div>
        <button class="btn btn-success mt-2" onclick="submitSurvey()">Enviar Resultado</button>
      </div>
      <!-- Company Evaluation -->
      <div id="surveyCompany" style="display: none;" class="survey-card">
        <h4>Avaliação de Satisfação</h4>
        <p>A comunicação foi encerrada. Por favor, avalie.</p>
        <div class="mb-3">
          <label class="form-label">Nota:</label>
          <div class="rating-radios" id="ratingCompany">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="companyRating" id="companyRating1" value="1">
              <label class="form-check-label" for="companyRating1">1</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="companyRating" id="companyRating2" value="2">
              <label class="form-check-label" for="companyRating2">2</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="companyRating" id="companyRating3" value="3">
              <label class="form-check-label" for="companyRating3">3</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="companyRating" id="companyRating4" value="4">
              <label class="form-check-label" for="companyRating4">4</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="companyRating" id="companyRating5" value="5">
              <label class="form-check-label" for="companyRating5">5</label>
            </div>
          </div>
        </div>
        <div class="mb-3">
          <label for="companyFeedbackText" class="form-label">Avaliação Descritiva (Opcional):</label>
          <textarea id="companyFeedbackText" class="form-control" rows="3"></textarea>
        </div>
        <button class="btn btn-success mt-2" onclick="submitSurvey()">Enviar Avaliação</button>
      </div>
      <!-- Display Company Evaluation for Auditor -->
      <div id="companyEvaluationDisplay" style="display: none;" class="survey-card mt-3">
        <h5>Avaliação Recebida da Empresa</h5>
        <p id="companyRatingText"></p>
        <p><strong>Comentário:</strong></p>
        <p id="companyFeedbackDisplayText" style="white-space: pre-wrap;"></p>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
  <script>
    // Mock data
    const companies = [
      { cnpj: "00.063.375", name: "CASA LIMPA INDUSTRIA E COMERCIO DE PRODUTOS DE LIMPEZA LTDA - ME", classification: "D", role: "CASA LIMPA" },
      { cnpj: "00.092.446", name: "ABS LOG TRANSPORTES E ORGANIZACAO LOGISTICA LTDA", classification: "A", role: "ABS LOG" },
      { cnpj: "00.116.275", name: "CAPIXABA COMERCIO DE MATERIAIS DE CONSTRUCAO LTDA", classification: "D", role: "CAPIXABA" }
    ];
    let communications = []; // Array to hold all communication threads
    let evaluations = {}; // Avaliações por CNPJ: { cnpj: { auditorRating, auditorFeedback, companyRating, companyFeedbackText, auditorHasRated, companyHasRated } }
    let communicationIdCounter = 0; // Simple ID generator

    // Current state
    let currentRole = "AUDITOR";
    let currentCompany = null; // { cnpj, name, role }
    let currentCommunicationId = null; // ID da comunicação aberta no chat
    let isInboxViewActive = false;

    // --- Helper Functions ---
    function generateCommId() {
    communicationIdCounter++;
    return `#${communicationIdCounter}`;
	}

    function getCommunicationById(id) {
      return communications.find(c => c.id === id);
    }

    // Encontra a comunicação MAIS RECENTE (qualquer status) para um dado CNPJ
    function findLatestCommunication(cnpj) {
      const companyComms = communications.filter(c => c.cnpj === cnpj)
        .sort((a, b) => b.messages[0].timestamp - a.messages[0].timestamp);
      return companyComms.length > 0 ? companyComms[0] : null;
    }

    // Encontra a comunicação MAIS RECENTE com status diferente de 'Encerrada'
    function findLatestActiveCommunication(cnpj) {
      const companyComms = communications
        .filter(c => c.cnpj === cnpj && c.status !== 'Encerrada')
        .sort((a, b) => b.messages[0].timestamp - a.messages[0].timestamp);
      return companyComms.length > 0 ? companyComms[0] : null;
    }

    // Cria uma nova comunicação ou retorna a última ativa
    function getOrCreateCommunication(cnpj, forceNew = false) {
      if (!forceNew) {
        const activeComm = findLatestActiveCommunication(cnpj);
        if (activeComm) {
          return activeComm;
        }
      }
      const company = companies.find(c => c.cnpj === cnpj);
      const newComm = {
        id: generateCommId(),
        cnpj,
        subject: "Confia Paraná",
        status: "Em análise",
        messages: [{
          sender: "Sistema",
          text: "Comunicação iniciada.",
          status: "Em análise",
          timestamp: new Date()
        }],
        responsible: "AUDITOR",
        auditorHasRated: false,
        companyHasRated: false
      };
      communications.push(newComm);
      if (!evaluations[cnpj]) {
        evaluations[cnpj] = { auditorRating: null, auditorFeedback: {}, companyRating: null, companyFeedbackText: '', auditorHasRated: false, companyHasRated: false };
      }
      evaluations[cnpj].auditorHasRated = false;
      evaluations[cnpj].companyHasRated = false;
      return newComm;
    }

    function getSelectedRadioValue(name) {
      const radios = document.getElementsByName(name);
      for (let i = 0; i < radios.length; i++) {
        if (radios[i].checked) return radios[i].value;
      }
      return null;
    }

    function needsAttention(comm) {
      if (!comm || !comm.messages || comm.messages.length === 0 || comm.status === "Encerrada") return false;
      const company = companies.find(c => c.cnpj === comm.cnpj);
      if (!company) return false;
      const lastMessage = comm.messages[comm.messages.length - 1];
      return comm.status !== "Encerrada" && (
        (currentRole === "AUDITOR" && lastMessage.sender !== "AUDITOR" && lastMessage.sender !== "Sistema") ||
        (currentRole === company.role && lastMessage.sender !== currentRole && lastMessage.sender !== "Sistema")
      );
    }

    // --- Core UI Functions ---
    function switchRole(role) {
      currentRole = role;
      document.getElementById("currentRole").textContent = role;
      document.getElementById("chatBox").style.display = "none";
      document.getElementById("communicationsPanel").style.display = "none";
      isInboxViewActive = false;
      document.getElementById("inboxBtn").classList.remove('active');
      currentCompany = null;
      currentCommunicationId = null;
      document.getElementById("panelButtonContainer").style.display = (role === 'AUDITOR') ? 'flex' : 'none';
      populateCompanyList();
      updateInboxStatus();
    }

    function populateCompanyList() {
      const companyList = document.getElementById("companyList");
      const statusFilter = document.getElementById("statusFilter").value;
      const cnpjFilter = document.getElementById("cnpjFilter").value.toLowerCase();
      companyList.innerHTML = "";

      let displayCompanies = companies.filter(company => {
        if (currentRole !== "AUDITOR") return company.role === currentRole;
        return true;
      }).filter(company => {
        const latestComm = findLatestCommunication(company.cnpj);
        const currentStatus = latestComm ? latestComm.status : "Sem comunicação";
        const matchesStatus = statusFilter ? currentStatus === statusFilter : true;
        const matchesCNPJ = cnpjFilter ? company.cnpj.toLowerCase().includes(cnpjFilter) : true;
        const matchesInbox = isInboxViewActive ? (latestComm && needsAttention(latestComm)) : true;
        return matchesStatus && matchesCNPJ && matchesInbox;
      });

      displayCompanies.forEach(company => {
        const latestComm = findLatestCommunication(company.cnpj);
        const companyEval = evaluations[company.cnpj] || {};
        const row = document.createElement("tr");
        let actionButtonHTML = '-';

        if (currentRole === "AUDITOR") {
          if (!latestComm || latestComm.status === 'Encerrada') {
            actionButtonHTML = `<button class="btn btn-primary btn-sm" onclick="startChat('${company.cnpj}', '${company.name}', '${company.role}', null, true)">Iniciar Comunicação</button>`;
          } else {
            actionButtonHTML = `<button class="btn btn-primary btn-sm" onclick="startChat('${company.cnpj}', '${company.name}', '${company.role}', '${latestComm.id}')">Abrir Comunicação (${latestComm.id})</button>`;
          }
        } else { // Usuário Empresa
          if (latestComm) {
            if (latestComm.status !== 'Encerrada') {
              actionButtonHTML = `<button class="btn btn-info btn-sm" onclick="startChat('${company.cnpj}', '${company.name}', '${company.role}', '${latestComm.id}')">Abrir Comunicação (${latestComm.id})</button>`;
            } else if (!companyEval.companyHasRated) {
              actionButtonHTML = `<button class="btn btn-warning btn-sm" onclick="openEvaluation('${company.cnpj}', '${company.name}', '${company.role}', '${latestComm.id}')">Avaliar (${latestComm.id})</button>`;
            } else {
              actionButtonHTML = `<span class="text-muted">Avaliado</span>`;
            }
          } else {
            // Se não houver comunicação e a empresa for de classificação "A", permite iniciar comunicação
            if (company.classification === "A") {
              actionButtonHTML = `<button class="btn btn-primary btn-sm" onclick="startChat('${company.cnpj}', '${company.name}', '${company.role}', null, true)">Iniciar Comunicação</button>`;
            } else {
              actionButtonHTML = '-';
            }
          }
        }

        const divulgarButton = currentRole === 'AUDITOR' ? `<button class="btn btn-success btn-sm" onclick="distributeTask('${company.cnpj}')">Divulgar</button>` : '-';

        row.innerHTML = `
          <td>${company.cnpj}</td>
          <td>${company.name}</td>
          <td>${company.classification}</td>
          <td>${divulgarButton}</td>
          <td>${actionButtonHTML}</td>
        `;
        companyList.appendChild(row);
      });
    }

    function updateInboxStatus() {
      let inboxCount = 0;
      communications.forEach(comm => {
        if (needsAttention(comm)) { inboxCount++; }
      });
      const inboxIcon = document.getElementById("inboxIcon");
      const inboxCountSpan = document.getElementById("inboxCount");
      if (inboxCount > 0) {
        inboxIcon.classList.add("active");
        inboxCountSpan.style.display = "inline";
        inboxCountSpan.textContent = inboxCount;
      } else {
        inboxIcon.classList.remove("active");
        inboxCountSpan.style.display = "none";
      }
    }

    function toggleInboxView() {
      isInboxViewActive = !isInboxViewActive;
      document.getElementById("inboxBtn").classList.toggle('active', isInboxViewActive);
      populateCompanyList();
    }

    function applyFilters() {
      isInboxViewActive = false;
      document.getElementById("inboxBtn").classList.remove('active');
      populateCompanyList();
    }

    // --- Communications Panel (Auditor Only) ---
    function toggleCommunicationsPanel() {
  if (currentRole !== 'AUDITOR') return;
  const panel = document.getElementById("communicationsPanel");
  const consultaContainer = document.getElementById("consultaEmpresasContainer");
  const inboxContainer = document.getElementById("inboxContainer");
  const panelButton = document.getElementById("communicationsPanelBtn");
  if (panel.style.display === "none") {
    populateCommunicationsPanel();
    panel.style.display = "block";
    if (consultaContainer) consultaContainer.style.display = "none";
    if (inboxContainer) inboxContainer.style.display = "none";
    document.getElementById("chatBox").style.display = "none";
    // Altera o texto e a cor do botão para azul (btn-primary)
    panelButton.textContent = "Voltar para relação de empresas";
    panelButton.className = "btn btn-primary";
  } else {
    panel.style.display = "none";
    if (consultaContainer) consultaContainer.style.display = "block";
    if (inboxContainer) inboxContainer.style.display = "block";
    // Restaura o texto original e a classe original (btn-secondary)
    panelButton.textContent = "Painel de Comunicações";
    panelButton.className = "btn btn-secondary";
  }
}

    function populateCommunicationsPanel() {
      if (currentRole !== 'AUDITOR') return;
      const panelList = document.getElementById("communicationsPanelList");
      panelList.innerHTML = "";
      const cnpjFilterPanel = document.getElementById("panelCnpjFilter").value.toLowerCase();
      const nameFilterPanel = document.getElementById("panelNameFilter").value.toLowerCase();
      const filteredComms = communications.filter(comm => {
        const company = companies.find(c => c.cnpj === comm.cnpj);
        if (!company) return false;
        const matchesCnpj = cnpjFilterPanel ? comm.cnpj.toLowerCase().includes(cnpjFilterPanel) : true;
        const matchesName = nameFilterPanel ? company.name.toLowerCase().includes(nameFilterPanel) : true;
        return matchesCnpj && matchesName;
      }).sort((a, b) => b.messages[0].timestamp - a.messages[0].timestamp);

      if (filteredComms.length === 0) {
        panelList.innerHTML = '<tr><td colspan="6">Nenhuma comunicação encontrada com os filtros aplicados.</td></tr>';
        return;
      }

      filteredComms.forEach(comm => {
        const company = companies.find(c => c.cnpj === comm.cnpj);
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${comm.id}</td>
          <td>${comm.cnpj}</td>
          <td>${company.name}</td>
          <td>${comm.subject}</td>
          <td>${comm.status}</td>
          <td>
            <button class="btn btn-info btn-sm" onclick="openChatFromPanel('${comm.id}')">
              Abrir (${comm.id})
            </button>
          </td>
        `;
        panelList.appendChild(row);
      });
    }

    function openChatFromPanel(communicationIdToOpen) {
      const comm = getCommunicationById(communicationIdToOpen);
      if (comm) {
        const company = companies.find(c => c.cnpj === comm.cnpj);
        startChat(comm.cnpj, company.name, company.role, communicationIdToOpen);
        document.getElementById("communicationsPanel").style.display = "none";
      } else {
        alert("Erro: Comunicação não encontrada.");
      }
    }

    function openEvaluation(cnpj, name, role, communicationIdToOpen) {
      if (currentRole !== role) return;
      startChat(cnpj, name, role, communicationIdToOpen);
    }

    // --- Chat Box Functions ---
    function startChat(cnpj, name, role, communicationIdToOpen = null, forceNew = false) {
      let comm;
      if (communicationIdToOpen) {
        comm = getCommunicationById(communicationIdToOpen);
        if (!comm) {
          alert("Erro: Comunicação não encontrada.");
          return;
        }
      } else {
        comm = getOrCreateCommunication(cnpj, forceNew);
      }
      currentCompany = { cnpj, name, role };
      currentCommunicationId = comm.id;

      // Se for uma nova comunicação iniciada (forceNew=true), mostra o popup
      if (!communicationIdToOpen && forceNew) {
        showEmailSentPopup();
      }

      document.getElementById("chatBox").style.display = "block";
      document.getElementById("communicationsPanel").style.display = "none";
      document.getElementById("companyName").textContent = name;
      document.getElementById("companyCNPJ").textContent = cnpj;
      document.getElementById("chatCommId").textContent = comm.id;
      document.getElementById("subject").value = comm.subject;

      const messageInput = document.getElementById("messageInput");
      const sendMessageBtn = document.getElementById("sendMessageBtn");
      const closeChatBtn = document.getElementById("closeChatBtn");
      const surveyAuditor = document.getElementById("surveyAuditor");
      const surveyCompany = document.getElementById("surveyCompany");
      const companyEvaluationDisplay = document.getElementById("companyEvaluationDisplay");

      messageInput.disabled = false;
      sendMessageBtn.disabled = false;
      closeChatBtn.style.display = "none";
      surveyAuditor.style.display = "none";
      surveyCompany.style.display = "none";
      companyEvaluationDisplay.style.display = "none";

      const companyEval = evaluations[cnpj] || {};

      if (comm.status === "Encerrada") {
        messageInput.disabled = true;
        sendMessageBtn.disabled = true;
        closeChatBtn.style.display = "none";

        if (currentRole === role && !companyEval.companyHasRated) {
          surveyCompany.style.display = "block";
          document.getElementsByName('companyRating').forEach(radio => radio.checked = false);
          document.getElementById('companyFeedbackText').value = '';
        }
        if (currentRole === 'AUDITOR') {
          if (companyEval.companyHasRated) {
            document.getElementById("companyRatingText").textContent = `Nota da Empresa: ${companyEval.companyRating || 'N/A'}/5`;
            document.getElementById("companyFeedbackDisplayText").textContent = companyEval.companyFeedbackText || '(Nenhum comentário adicional)';
            companyEvaluationDisplay.style.display = "block";
          } else {
            document.getElementById("companyRatingText").textContent = `Empresa ainda não avaliou esta comunicação.`;
            document.getElementById("companyFeedbackDisplayText").textContent = '';
            companyEvaluationDisplay.style.display = "block";
          }
        }
      } else {
        messageInput.disabled = false;
        sendMessageBtn.disabled = false;
        if (currentRole === "AUDITOR") {
          closeChatBtn.style.display = "inline-block";
        }
      }

      updateChatMessages(comm.messages);
      updateInboxStatus();
    }

    function sendMessage() {
      if (!currentCommunicationId) return;
      const comm = getCommunicationById(currentCommunicationId);
      if (!comm || comm.status === "Encerrada") return;
      const messageInput = document.getElementById("messageInput");
      const attachment = document.getElementById("attachment").files[0];
      const subject = document.getElementById("subject").value;
      const messageText = messageInput.value.trim();
      if (!messageText) return;
      comm.messages.push({
        sender: currentRole,
        text: `Assunto: ${subject}\nMensagem: ${messageText}${attachment ? "\nAnexo: " + attachment.name : ""}`,
        status: comm.status,
        timestamp: new Date()
      });
      comm.subject = subject;
      messageInput.value = "";
      document.getElementById("attachment").value = "";
      updateChatMessages(comm.messages);
      updateInboxStatus();
    }

    function updateChatMessages(messages) {
      const chatMessages = document.getElementById("chatMessages");
      chatMessages.innerHTML = "";
      if (!messages) return;
      messages.forEach(msg => {
        const messageDiv = document.createElement("div");
        messageDiv.className = "message";
        messageDiv.innerHTML = `<div class="sender">${msg.sender}</div><div>${msg.text.replace(/\n/g, '<br>')}</div><div class="status">Status: ${msg.status} | ${msg.timestamp.toLocaleString()}</div>`;
        chatMessages.appendChild(messageDiv);
      });
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function distributeTask(cnpj) {
      if (currentRole !== "AUDITOR") { alert("Apenas o Auditor pode distribuir tarefas."); return; }
      console.log(`Auditor ${currentRole} distribuiu/divulgou tarefa para ${cnpj}.`);
      alert(`Tarefa/Divulgação iniciada para ${cnpj}.`);
    }

    function closeChat() {
      if (currentRole !== 'AUDITOR' || !currentCommunicationId) return;
      const comm = getCommunicationById(currentCommunicationId);
      if (!comm || comm.status === "Encerrada") return;
      comm.messages.push({ sender: "Sistema", text: `Comunicação ${comm.id} encerrada pelo Auditor (${currentRole}).`, status: "Encerrada", timestamp: new Date() });
      comm.status = "Encerrada";
      updateChatMessages(comm.messages);
      updateInboxStatus();
      populateCompanyList();
      const companyEval = evaluations[comm.cnpj] || {};
      if (!companyEval.auditorHasRated) {
        document.getElementById("surveyAuditor").style.display = "block";
        document.getElementsByName('auditorRating').forEach(radio => radio.checked = false);
        document.getElementById('communicationWithAuditor').value = '';
        document.getElementById('programAdvantagesAuditor').value = '';
        document.getElementById('pendingResolutionAuditor').value = '';
      }
      document.getElementById("messageInput").disabled = true;
      document.getElementById("sendMessageBtn").disabled = true;
      document.getElementById("closeChatBtn").style.display = "none";
    }

    function submitSurvey() {
      if (!currentCompany || !currentCompany.cnpj) return;
      const cnpj = currentCompany.cnpj;
      if (!evaluations[cnpj]) {
        evaluations[cnpj] = { auditorRating: null, auditorFeedback: {}, companyRating: null, companyFeedbackText: '', auditorHasRated: false, companyHasRated: false };
      }
      if (currentRole === "AUDITOR") {
        const communicationWith = document.getElementById("communicationWithAuditor").value;
        const programAdvantages = document.getElementById("programAdvantagesAuditor").value;
        const pendingResolution = document.getElementById("pendingResolutionAuditor").value;
        const rating = getSelectedRadioValue("auditorRating");
        if (communicationWith && programAdvantages && pendingResolution && rating) {
          evaluations[cnpj].auditorRating = rating;
          evaluations[cnpj].auditorFeedback = { communicationWith, programAdvantages, pendingResolution };
          evaluations[cnpj].auditorHasRated = true;
          console.log(`Resultado do Contato (Auditor) para ${cnpj} (Comm: ${currentCommunicationId}) enviado: Nota ${rating}/5.`);
          document.getElementById("surveyAuditor").style.display = "none";
        } else {
          alert("Por favor, preencha todos os campos do resultado do contato, incluindo a nota.");
        }
      } else {
        const rating = getSelectedRadioValue("companyRating");
        const feedbackText = document.getElementById("companyFeedbackText").value.trim();
        if (rating) {
          evaluations[cnpj].companyRating = rating;
          evaluations[cnpj].companyFeedbackText = feedbackText;
          evaluations[cnpj].companyHasRated = true;
          console.log(`Avaliação da Empresa (${currentRole} - ${cnpj}, Comm: ${currentCommunicationId}) enviada: Nota ${rating}/5.`);
          document.getElementById("surveyCompany").style.display = "none";
          document.getElementById("chatBox").style.display = "none";
          populateCompanyList();
        } else {
          alert("Por favor, selecione uma nota de 1 a 5.");
        }
      }
    }

    // --- Popup de Notificação ---
    function showEmailSentPopup() {
      const popup = document.createElement('div');
      popup.id = 'emailSentPopup';
      popup.style.position = 'fixed';
      popup.style.top = '20px';
      popup.style.right = '20px';
      popup.style.backgroundColor = '#ffc107';
      popup.style.color = '#000';
      popup.style.padding = '15px';
      popup.style.borderRadius = '5px';
      popup.style.boxShadow = '0 2px 5px rgba(0,0,0,0.3)';
      popup.style.zIndex = '1000';
      popup.innerHTML = 'Foi enviado um e-mail sobre o início do contato <button style="background: none; border: none; font-weight: bold; cursor: pointer;" onclick="dismissPopup()">X</button>';
      document.body.appendChild(popup);
      setTimeout(function() {
        if(document.body.contains(popup)) {
          document.body.removeChild(popup);
        }
      }, 5000);
    }

    function dismissPopup() {
      const popup = document.getElementById('emailSentPopup');
      if(popup) {
        document.body.removeChild(popup);
      }
    }

    // --- Initial Setup ---
    switchRole('AUDITOR');
  </script>
</body>
</html>
